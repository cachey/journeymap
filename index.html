<!DOCTYPE html><html>
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.bundle.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/0.5.7/chartjs-plugin-annotation.min.js"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.min.css">
	<link href="https://fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">
	<style>
	#chartjs-tooltip {
		opacity: 1;
		position: absolute;
		background: rgba(242, 242, 242);
		border-radius: 1px;
		-webkit-transition: all .1s ease;
		transition: all .1s ease;
		pointer-events: none;
		-webkit-transform: translate(-50%, 0);
		transform: translate(-50%, 0);
	}
	td {
		padding: 0px:
	}
	.chartjs-tooltip-key {
		display: inline-block;
		width: 1px;
		height: 1px;
		margin-right: 10px;
	}
	</style>
	<title>Palliative Care Journey Map Viewer</title>
</head>
<body style="padding: 20px">
	<table style="table-layout: fixed;">
	<tr><td  width="500px">
	<input id="nCase" value="14"> of <span id="numPatients"></span> patients <button onclick="loadPatient();">Load</button><br>

	<h4 id="demo-title"></h4>
	<b>Primary Diagnosis: </b><span id="primaryDx"></span><br>
	<b>Secondary Diagnosis: </b><span id="secondDx"></span>
	</td><td width="500px">
	<button onclick="document.getElementById('nCase').value = parseInt(document.getElementById('nCase').value)-1; loadPatient();">Previous</button>
	<button onclick="document.getElementById('nCase').value = parseInt(document.getElementById('nCase').value)+1; loadPatient();">Next</button>
	<div id="ptInfo1" style="font-size: 14px;"></div>
	</td><td width="500px">
	<div id="ptInfo2" style="font-size: 14px;"></div>
	</td></tr></table>
	<canvas id="chartarea" height="100%"></canvas>
	<script src="data.js"></script>
<script>
document.getElementById("numPatients").innerHTML = records.length;
for (var i = 0; i < records.length; i++) {
	for (var enc in records[i].encounters) {
		records[i].encounters[enc] = JSON.parse(records[i].encounters[enc]);
	}
}
var chart, ctx;
var AKPS = [];
var RUGADL = [];
var Admissions = [];
var typeKey = {
	"ED": -6,
	"WARD": -14,
	"ICU": -20,
	"OUTPT": -30,
	"COMM": -50,
	"OTHER": 0
};
var colKey = { //TODO: finish this
	"ED": "rgb(17, 152, 169)",
	"WARD": "rgb(20, 69, 166)",
	"ICU": "rgb(242, 188, 27)",
	"OUTPT": "rgb(223, 107, 108)",
	"COMM": "rgb(15, 166, 68)",
	"OTHER": 0
};
var customTooltips = function(tooltip) {
// Tooltip Element
	// tooltip.dataPoints[0] -> datasetIndex, index
	var tooltipEl = document.getElementById('chartjs-tooltip');
	if (!tooltipEl) {
		tooltipEl = document.createElement('div');
		tooltipEl.id = 'chartjs-tooltip';
		tooltipEl.innerHTML = '<table></table>';
		this._chart.canvas.parentNode.appendChild(tooltipEl);
	}
	// Hide if no tooltip
	if (tooltip.opacity === 0) {
		tooltipEl.style.opacity = 0.7;
		return;
	}
	// Set caret Position
	tooltipEl.classList.remove('above', 'below', 'no-transform');
	if (tooltip.yAlign) {
		tooltipEl.classList.add(tooltip.yAlign);
	} else {
		tooltipEl.classList.add('no-transform');
	}
	var info;
	var innerHtml = "";
	var tableRoot = tooltipEl.querySelector('table');
	for (let ep of tooltip.dataPoints) {
		if (ep.datasetIndex > 1) {
			info = chart.data.datasets[ep.datasetIndex].data[ep.index].attrib;
			if (tooltip.body) {
				innerHtml += "<b>Day " + (365 - parseInt(ep.label)).toString() + "</b>&nbsp;";
				// need to add if here to stop TypeError
				Object.keys(info).forEach(function(key) {
					innerHtml += '<b>' + key + ':</b> ' + info[key] + '<br>';
				});
			}
		} else {
			innerHtml += "<b>Day " + tooltip.dataPoints[0].label + "</b><br>";
			innerHtml += tooltip.body[0].lines[0];
		}
		innerHtml += "<br>";
	}
	// Set Text
	tableRoot.innerHTML = innerHtml;
	var positionY = this._chart.canvas.offsetTop;
	var positionX = this._chart.canvas.offsetLeft;
	// Display, position, and set styles for font
	tooltipEl.style.opacity = 1;
	tooltipEl.style.left = positionX + tooltip.caretX + 'px';
	tooltipEl.style.top = positionY + tooltip.caretY + 'px';
	tooltipEl.style.fontFamily = tooltip._bodyFontFamily;
	tooltipEl.style.fontSize = tooltip.bodyFontSize + 'px';
	tooltipEl.style.fontStyle = tooltip._bodyFontStyle;
	tooltipEl.style.padding = tooltip.yPadding + 'px ' + tooltip.xPadding + 'px';
};
var loadPatient = function() {
try {
    chart.destroy();
} catch {
	console.log("First patient");
}

if (document.getElementById('chartjs-tooltip')) {
	document.getElementById('chartjs-tooltip').style.opacity = 0;
}

var patient = records[parseInt(document.getElementById("nCase").value)-1];
document.getElementById("demo-title").innerHTML = patient.age + " " + patient.gender;
document.getElementById("primaryDx").innerHTML = patient.ptinfo["Primary diagnosis"];
document.getElementById("secondDx").innerHTML = patient.ptinfo["Secondary diagnosis"];
var text = "";
Object.keys(patient.ptinfo).forEach(function(key) {
	if (key.search("diagnosis") === -1) {
		text += "<b>" + key + ":</b> " + patient.ptinfo[key] + "<br>";
	}
});

document.getElementById("ptInfo1").innerHTML = text.substring(0, text.search("<b>ACP/MEPOA"));
document.getElementById("ptInfo2").innerHTML = text.substring(text.search("<b>ACP/MEPOA"));
ctx = document.getElementById('chartarea').getContext('2d');
// generate the AKPS and RUG-ADL datasets
// AKPS - 0-100 (left side).
// RUG-ADL - 0-18 (right side).
AKPS = [];
RUGADL = [];
Admissions = [];

for (var i in Object.keys(typeKey)) {
	Admissions[Object.keys(typeKey)[i]] = [];
}
for (var enc in patient.encounters) {
	if (patient.encounters[enc].cat === "WARD") {
    var x, y;
    if ("AKPS on admission" in patient.encounters[enc].attrib) {
			x = patient.encounters[enc].d;
			y = parseInt(patient.encounters[enc].attrib["AKPS on admission"]);
			AKPS.push({'x':x, 'y':y});
		}
		if ("AKPS on discharge" in patient.encounters[enc].attrib && "Calculated LOS" in patient.encounters[enc].attrib) {
			x = patient.encounters[enc].d + parseInt(patient.encounters[enc].attrib["Calculated LOS"]);
			y = parseInt(patient.encounters[enc].attrib["AKPS on discharge"]);
			AKPS.push({'x':x, 'y':y});
		}
		if ("RUG-ADL on admission" in patient.encounters[enc].attrib) {
			x = patient.encounters[enc].d;
			y = parseInt(patient.encounters[enc].attrib["RUG-ADL on admission"]);
			RUGADL.push({'x':x, 'y':18-y});
		}
		if ("RUG-ADL on discharge" in patient.encounters[enc].attrib && "Calculated LOS" in patient.encounters[enc].attrib) {
			x = patient.encounters[enc].d + parseInt(patient.encounters[enc].attrib["Calculated LOS"]);
			y = parseInt(patient.encounters[enc].attrib["RUG-ADL on discharge"]);
			RUGADL.push({'x':x, 'y':18-y});
		}
	}
	var ex = patient.encounters[enc].d;
	var ey = typeKey[patient.encounters[enc].cat];
	Admissions[patient.encounters[enc].cat].push({'x':ex, 'y':ey, attrib:patient.encounters[enc].attrib});
}
// sort the scoring
AKPS.sort(function(a, b) {
	return a.x - b.x;
});
RUGADL.sort(function(a, b) {
	return a.x - b.x;
});

chart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: [],
        datasets: [{
            label: "AKPS",
			fill: false,
			data: AKPS,
			yAxisID: 'AKPS',
			backgroundColor: 'rgb(242, 143, 56)',
			borderColor: 'rgb(242, 143, 56, 0.4)',
			lineTension: 0.25
        }, {
			label: "RUG-ADL",
			fill: false,
			data: RUGADL,
			yAxisID: 'RUGADL',
			backgroundColor: 'rgb(89, 181, 217)',
			borderColor: 'rgb(89, 181, 217, 0.4)',
			lineTension: 0.15
		}, {
			data: Admissions["ED"],
			yAxisID: 'AKPS',
			fill: false,
			showLine: false,
			pointRadius: 6,
			pointHoverRadius: 10,
			backgroundColor: colKey["ED"]
		}, {
			data: Admissions["WARD"], // TODO autogenerate this
			yAxisID: 'AKPS',
			fill: false,
			showLine: false,
			pointRadius: 6,
			pointHoverRadius: 10,
			backgroundColor: colKey["WARD"]
		}, {
			data: Admissions["ICU"],
			yAxisID: 'AKPS',
			fill: false,
			showLine: false,
			pointRadius: 12,
			pointHoverRadius: 12,
			backgroundColor: colKey["ICU"]
		}, {
			data: Admissions["OUTPT"],
			yAxisID: 'AKPS',
			fill: false,
			showLine: false,
			pointRadius: 6,
			pointHoverRadius: 10,
			backgroundColor: 'rgb(223, 107, 108)'
		}, {
			data: Admissions["COMM"],
			yAxisID: 'AKPS',
			fill: false,
			showLine: false,
			pointRadius: 6,
			pointHoverRadius: 10,
			backgroundColor: 'rgb(15, 166, 68)'
		}]
    },
    options: {
		legend: {
			display: false
		},
		scales: {
            yAxes: [{
                type: 'linear',
				display: true,
				position: 'left',
				id: 'AKPS',
				ticks: {
                    beginAtZero: true,
                    min: -60,
                    max: 100,
					stepSize: 20,
                    callback: function(value, index, values) {
                        return (value >= 0 ? value : "");
                    }
				},
				gridLines: {
					color: Array(6).fill("rgb(0, 0, 0, 0.1)").concat(Array(3).fill("#FFFFFF"))
				}
            }, {
				type: 'linear',
				display: true,
				position: 'right',
				id: 'RUGADL',
				ticks: {
                    beginAtZero: false,
					min: -8.4,
                    max: 14,
					callback: function(value, index, values) {
                        return (value >= 0 ? 18-value : "");
                    }
                },
				gridLines: {
					drawOnChartArea: false // only want the grid lines for one axis to show up
				}
			}],
            xAxes: [{
                id: 'time',
				type: 'linear',
				ticks: {
                    beginAtZero: true,
                    min: -35,
                    max: 392,
					stepSize: 14,
					padding: (window.innerWidth > 1000? -255 : 0),
					callback: function(value, index, values) {
						return ((value < 365 && value >= 0) ? 364 - value : ""); // TODO: fix this - hacky. number of days prior to death
					}
                }
            }]
        },
		tooltips: {
			enabled: false,
			mode: 'nearest',
			intersect: true,
			position: 'average',
			custom: customTooltips
		},
		annotation: {
			annotations: [{ // can be automated - labels only for series that exist
				type: "line",
				mode: "horizontal",
				scaleID: "AKPS",
				value: typeKey["ED"],
				borderColor: colKey["ED"].slice(0, -1) + ", 0.4)",
				borderWidth: 0,
				label: {
				  backgroundColor: colKey["ED"],
				  position: "left",
				  content: "ED attendances",
				  enabled: true
				}
			}, {
				type: "line",
				mode: "horizontal",
				scaleID: "AKPS",
				value: typeKey["WARD"],
				borderColor: colKey["WARD"].slice(0, -1) + ", 0.4)",
				borderWidth: 0,
				label: {
				  backgroundColor: colKey["WARD"],
				  position: "left",
				  content: "Ward admissions",
				  enabled: true
				}
			}, {
				type: "line",
				mode: "horizontal",
				scaleID: "AKPS",
				value: typeKey["OUTPT"],
				borderColor: colKey["OUTPT"].slice(0, -1) + ", 0.4)",
				borderWidth: 0,
				label: {
				  backgroundColor: colKey["OUTPT"],
				  position: "left",
				  content: "Outpatient visits",
				  enabled: true
				}
			}, {
				type: "line",
				mode: "horizontal",
				scaleID: "AKPS",
				value: typeKey["COMM"],
				borderColor: colKey["COMM"].slice(0, -1) + ", 0.4)",
				borderWidth: 0,
				label: {
				  backgroundColor: colKey["COMM"],
				  position: "left",
				  content: "Community services",
				  enabled: true
				}
			}]
		}
	}
});
for (var enc in patient.encounters) {
	if ("Calculated LOS" in patient.encounters[enc].attrib) {
		var boxLOS = {
			type: 'box',
			xScaleID: 'time',
			yScaleID: 'AKPS',
			xMin: patient.encounters[enc].d,
			xMax: patient.encounters[enc].d + patient.encounters[enc].attrib["Calculated LOS"],
			yMax: typeKey[patient.encounters[enc].cat] + 2,
			yMin: typeKey[patient.encounters[enc].cat] - 2,
			backgroundColor: colKey[patient.encounters[enc].cat].slice(0, -1) + ", 0.4)",
			borderColor: colKey[patient.encounters[enc].cat].slice(0, -1) + ", 0.4)"
		};
		chart.options.annotation.annotations.push(boxLOS);
	}
}
chart.update();
}

loadPatient();
</script>
</body>
</html>
